---
date: '2025-05-07T21:32:53+02:00'
draft: false
title: 'Chapitre 1 - Le design'
summary: "Homelab - Chapitre 1 - Le design"
tags: ["homelab"]
categories: ["homelab"]
---

> Ce document contient les livrables issus de la phase de design du homelab. On doit se poser les bonnes questions pour r√©pondre efficacement au besoin de d√©part, √† savoir, disposer d'un environnement o√π l'on peut d√©ployer rapidement des serveurs pr√™t √† l'emploi pour divers cas d'usage. La conception est susceptible de changer au fur et √† mesure des travaux, cette page est donc susceptible d'√©voluer (mise √† jour de l'inventaire, ajout de services/fonctionnalit√©s, ...)

---

# 1. Le hardware

> Cette section est susceptible d'√©voluer avec le temps. Des √©volutions peuvent √™tre appliqu√©es avec l'acquisition de plus de compute pour am√©liorer les performances et la r√©silience ainsi que la mise en place d'un syst√®me de stockage plus adapt√© comme un NAS.

Pour mettre en place ce homelab, il nous faut un appareil qui dispose de suffisamment de compute soit au moins 32Go de RAM et 16vCPU ainsi qu'un minimum d'espace disque soit 1To. De plus, cette machine va √™tre disponible tout le temps 24h/24 7j/7, il est donc important de prendre une solution qui ne consomme pas trop d'√©nergie.

| Date      | Compute      | Stockage      | Niveau de maturit√©      |
|:-:    |:-:    |:-:    |:-:    |
| 11/04/2025      | 1 node - E3B Mini PC (32Go RAM, 16 vCPU, 512Go SSD)     | 1 node - E3B Mini PC (512Go SSD)     | 1 üêü      |

---

# 1. Les environnements

Le homelab va √™tre divis√© en deux sous-r√©seaux principaux. Le premier ayant pour objectif d'h√©berger les divers services utiles au bon fonctionnement du homelab. Le second sera d√©di√© au d√©ploiement et √† l'utilisation des VMs et containers pour les tests futurs de technologie, OS, etc.

| Nom      | Description      | Adressage      |
|:-:    |---    |---    |
| Core      | Environnement de base du homelab (prod)      | 192.168.100.0/24      |
| VMS      | Environnement de d√©ploiement des VMs (sandbox)     | 192.168.200.0/24      |

---

# 2. Les services

Pour disposer d'un environnement fonctionnel et confortable, nous avons besoin de diff√©rents services que l'on va d√©tailler dans les sous-sections suivantes.

## 2.1. Firewall

Il s'agit de la seule VM qui aura une interface r√©seau directement sur mon r√©seau local (interface WAN d'un point de vue Firewall) et de ce fait, obtiendra une IP en 192.168.1.0/24. L'objectif est de g√©rer les autorisations concernant les communications entrantes et sortantes au niveau du homelab. Le choix technique se portera sur la solution `pfSense`.

## 2.2. Serveur DNS

Le DNS va nous permettre d'utiliser les noms associ√©s √† nos VM plut√¥t que les IP avec deux zones DNS `.homelab` (DNS interne du homelab) ainsi que `ng-hl.com` (le domaine qui portera les services expos√©s sur mon r√©seau local). Le choix technique se portera sur la solution `bind9`. 

## 2.3. Machine d'administration centrale

Cette VM sera le point d'entr√©e vers les ressources du homelab. L'objectif est d'avoir une machine en frontal juste derri√®re le firewall avec un acc√®s SSH ouvert depuis le WAN (mon r√©seau local) accessible √† certaines IP. Cette machine pourra faire office de rebond et pourra h√©berger un certain nombre d'outils.

## 2.4. Serveur de gestion des configuration

Ce service va nous permettre de d√©ployer les configurations des OS que nous d√©ployons. Les actions seront initialis√©es manuellement dans un premier temps puis nous pourrons int√©grer l'outil au sein d'une pipeline via Gitlab-CI plus tard. Le choix technique se portera sur la solution `Ansible`.

## 2.5. Coffre fort num√©rique

Le coffre-fort num√©rique va nous permettre de stocker divers mots de passe et secrets. Le choix technique se portera sur `VaultWarden`, solution alternative et open source √† BitWarden.

## 2.6. Serveur de versionning

Le serveur de versionning permettra la centralisation des diff√©rents √©l√©ments relatifs √† notre infrastructure notamment concernant l'infrastructure as code avec OpenTofu et Ansible. De plus, cette VM ouvre la possibilit√© d'automatiser nos d√©ploiements futurs de VM via les runners et les fonctionnalit√©s de la CI/CD. Le choix technique se portera sur la solution `Gitlab-ce`.

## 2.7. Stack d'observabilit√©

L'objectif est de disposer d'outils nous permettant de monitorer et de superviser les OS et les services gr√¢ce √† la collecte des m√©triques ainsi qu'√† l'alerting. Le choix technique se portera sur la "suite" `Prometheus/Grafana`.

## 2.8. Dashboard central

Afin de faciliter l'administration du homelab et l'utilisation des diff√©rents services, nous allons mettre en place un dashboard moderne et confortable afin d'inventorier l'int√©gralit√© des services mis √† disposition au sein du homelab. Le choix technique se portera sur `Homepage`

---

# 3. Sch√©ma r√©seau physique

![Sch√©ma physique](/images/schema_physique.png)

---

# 4. Sch√©ma r√©seau logique

![Sch√©ma logique](/images/schema_logique.png)

---

# 5. Priorisation

Afin de disposer rapidement d'un homelab fonctionnel avec le minimum de services requis, nous allons d√©finir diff√©rents niveaux de maturit√© avec les mises en place des diff√©rents services qui y sont associ√©es.

| Niveau     | Description      | Services     | D√©ploiement
|---    |:-:    |:-:    |:-:    |
| üêü    | Le homelab est fonctionnel, il est possible de d√©ployer des VMs pr√©configur√©es √† la main via des templates.      | Firewall, DNS, machine d'administration     | Template de VM sur Proxmox
| üê¨     | Le d√©ploiement des VM est uniforme et automatis√©. La machine de rebond centralis√©e peut communiquer avec l'enti√®ret√© des machines. Une PKI est en place ainsi que le nom de domaine ng-hl.com et une acme    | Gitlab-ce, , Ansible, PKI, certificat wildcard, acme     | Template de VM sur Proxmox avec OpenTofu et Ansible dans une pipeline Gitlab CI/CD 
| üê≥    | La stack d'observabilit√© est en place et le dashboard Homepage pr√™t √† l'emploi avec une √©volution dynamique.     | Prometheus, Grafana, Homepage, notifications (Discord ?)       | Image pr√©configur√©e sur Proxmox avec OpenTofu et Ansible dans une pipeline Gitlab CI/CD

---

# 6. Todo lists

## 6.1. üêü

- [x] Niveau 1
    - [x] Installation de Proxmox VE
    - [x] Configuration de Proxmox VE
        - [x] Cr√©ation de l'utilisateur d'administration
        - [x] Mise en place des bons d√©p√¥ts pour les mises √† jour
        - [x] Mise en place de la sauvegarde d√©port√©e
        - [x] Configuration des interfaces vmbr1 et vmbr2
        - [x] Tester le bon fonctionnement
    - [x] Installation de pfSense
        - [x] Importer l'ISO de pfSense
        - [x] Configurer la VM avec trois interfaces (vmbr0, vmbr1 et vmbr2)
        - [x] Installer l'OS via l'ISO
        - [x] Rendre disponible l'interface d'administration depuis le WAN (r√©seau local)
    - [x] Cr√©er un template de Debian 12
        - [x] Importer l'ISO de Debian 12
        - [x] Installer l'OS avec les √©l√©ments suivants
            - [x] Nom : debian12-template.homelab
            - [x] Disque : LVM partitionnement manuel
            - [x] Service : openssh-server
            - [x] Utilisateur : Cr√©ation de l'utilisateur d'administration
            - [x] Authentification : Int√©grer la cl√© SSH publique de l'utilisateur de la machine de gestion centralis√©e
            - [x] Utilisateur : Cr√©ation de l'utilisateur ansible (groupe sudo)
            - [x] Authentification : Int√©grer la cl√© SSH publique de l'utilisateur ansible
            - [x] R√©seau : Configuration statique 192.168.100.11/24
        - [x] Tester le bon fonctionnement avec le d√©ploiement d'une VM de test
        - [x] Convertir en tant que template
    - [x] Cr√©er un template de RockyLinux 9
        - [x] Importer l'ISO de RockyLinux 9
        - [x] Installer l'OS avec les √©l√©ments suivants
            - [x] Nom : rocky9-template.homelab
            - [x] Disque : LVM partitionnement manuel
            - [x] Service : openssh-server
            - [x] Utilisateur : Cr√©ation de l'utilisateur d'administration
            - [x] Authentification : Int√©grer la cl√© SSH publique de l'utilisateur de la machine de gestion centralis√©e
            - [x] Utilisateur : Cr√©ation de l'utilisateur ansible
            - [x] Authentification : Int√©grer la cl√© SSH publique de l'utilisateur ansible
            - [x] R√©seau : Configuration statique 192.168.100.12/24
        - [x] Tester le bon fonctionnement avec le d√©ploiement d'une VM de test
        - [x] Convertir en tant que template
    - [x] Installation du DNS (Bind9)
        - [x] Mise en place de l'OS via les templates
        - [x] Activer la sauvegarde depuis Proxmox
        - [x] Modifications mineures de l'OS (changement du hostname, configuration r√©seau)
        - [x] Installation de bind9
        - [x] Configuration de la zone DNS et du forwarder
        - [x] Configuration de la zone DNS inverse
        - [x] Tests
    - [x] Cr√©ation de la machine d'administration centrale `admin-core`
        - [x] Mise en place de l'OS via les templates
        - [x] Activer la sauvegarde depuis Proxmox
        - [x] Modifications mineures de l'OS (changement du hostname, configuration r√©seau)
        - [x] Modification de la configuration du r√©solveur DNS pour admin-core
        - [x] Test de la r√©solution interne depuis admin-core
        - [x] Test de la r√©solution externe depuis admin-core
        - [x] Importer les cl√©s priv√©es SSH utilis√©es au sein du homelab
        - [x] Modification du FW (acc√®s SSH depuis le WAN uniquement sur cette VM)

---

## 6.2. üê¨ 

- [ ] Niveau 2
    - [X] Mise en place de Ansible
        - [x] Mise en place de l'OS via les templates
        - [x] Activer la sauvegarde depuis Proxmox
        - [x] Modifications mineures de l'OS (changement du hostname, configuration r√©seau)
        - [x] Int√©gration sur admin-core (alias ssh)
        - [x] Installation de Ansible (via pipx)
        - [x] Configuration de Ansible
        - [x] Int√©gration des h√¥tes d√©j√† existants
            - [x] Installer le paquet python3
            - [x] Tester le bon fonctionnement des ex√©cutions Ansible
        - [x] Gestion de l'adresse IP temporaire pour les nouvelles VM
        - [x] Convertir les actions manuelles de configurations mineures avec Ansible (int√©grer les actions de la section S√©curisation -> Templates / VM, voir plus bas)
        - [x] Ajouter un linter
        - [x] Tester le bon fonctionnement
    - [x] S√©curisation
        - [x] pfSense
            - [x] Activer le HTTPS
            - [x] Activer le renouvellement automatique du certificat TLS
                - [x] Installation du module acme
                - [x] Configuration de l'Account Key acme
                - [x] Configuration du certificate acme
                - [x] Test avec le staging acme
                - [x] Faire un snapshot avec le passage en production
                - [x] Test avec la production acme
                - [x] Mise en place du HTTPS avec le certificat nouvellement cr√©√©
                - [x] V√©rification des autres services + forcer un renouvellement via acme depuis pfSense et depuis acme-core
        - [x] Templates / VM
            - [x] Durcissement de SSH
                - [x] D√©sactivation de l'acc√®s root en direct via SSH
                - [x] Acc√®s par cl√© uniquement
                - [x] Mise en place de fail2ban
            - [x] Mise en place de nftables
                - [x] Configuration de base (ping et ssh depuis admin-core)
    - [x] Mise en place de Gitlab
        - [x] Mise en place de l'OS via les templates
        - [x] Configuration de l'OS via Ansible
        - [x] Installation de Gitlab CE
        - [x] Configuration de base de Gitlab CE
        - [x] Configuration du HTTPS avec le certificat *.ng-hl.com
        - [x] Configuration du renouvellement automatique du certificat
        - [x] Tester le renouvellement du certificat (forcer) 
        - [x] Cr√©ation d'un compte administrateur nominatif
        - [x] Cr√©ation du groupe core
        - [x] Cr√©ation du projet core/ansible et versionner le code existant
        - [x] Cr√©ation du projet core/deploy
        - [x] Configuration l'utilisateur ngobert
            - [x] Cr√©er la paire de cl√© SSH pour l'utilisation de Git
            - [x] Stocker la pare de cl√© SSH au niveau du coffre-fort
    - [ ] OpenTofu
        - [x] Cr√©er le projet core/OpenTofu
        - [ ] Int√©gration du provider Proxmox
        - [ ] Cr√©ation d'une VM
        - [ ] Suppression d'une VM
        - [ ] R√©cup√©rer les informations pour avoir un inventaire dynamique
    - [x] Nom de domaine
        - [x] R√©server un nom de domaine (CloudFlare)
        - [x] G√©n√©rer le certificat wildcard *.ng-hl.com
        - [x] G√©rer le renouvellement automatique avec acme.sh
    - [ ] Append : Coffre fort (Vaultwarden)
        - [x] Mise en place de l'OS via les templates
        - [x] Configuration de l'OS via Ansible ou manuellement suivant l'ex√©cution de la t√¢che
        - [x] Installation de Vaultwarden
        - [x] Configuration de Vaultwarden
        - [x] Test d'utilisation
        - [ ] Stockage des √©l√©ments critiques
            - [ ] PKI
            - [x] Cl√©s SSH
            - [ ] Attribuer des mots de passe uniques (utilisateur ngobert, root et pfSense)
            - [ ] Int√©gration avec Gitlab CI
        - [x] Tests
    - [x] Certificat wildcard *.ng-hl.com
        - [x] R√©servation du nom de domaine
        - [x] Cr√©ation du certificat
        - [x] Automatisation du renouvellement du certificat
            - [x] Configuration de acme + test de renouvellement forc√©
            - [x] Script de d√©ploiement du nouveau certificat (index√© sur la liste des services expos√©s)
            - [x] Test de bout en bout
    - [ ] Pipeline CI/CD "vm-factory"

---

## 6.3. üê≥

- [ ] Prometheus
    - [x] Mise en place du serveur prometheus-core
    - [x] Int√©gration au niveau de la sauvegarde Proxmox VE
    - [x] Configuration de l'OS avec Ansible
    - [x] D√©ploiement de Prometheus
    - [x] Configuration de Prometheus
    - [ ] Configuration du TLS sur prometheus.ng-hl.com
        - [x] Connexion SSH en root via la cl√© SSH `id_acme` 
        - [ ] Rajout de la target `prometheus-core`
        - [ ] Rajout de la commande de reload du container pour application
    - [ ] Ouverture du flux sur pfSense vers prometheus-core
    - [ ] Int√©grer le renouvellement automatique du certificat via acme-core
    - [ ] Int√©gration d'un h√¥te de test
    - [ ] Cr√©ation d'un r√¥le Ansible "prometheus-agent"
    - [ ] R√©diger une ficher d'exploitation
- [ ] Grafana
    - [ ] Mise en place du serveur grafana-core
    - [ ] Int√©gration au niveau de la sauvegarde Proxmox VE
    - [ ] Configuration de l'OS avec Ansible
    - [ ] Installation de Grafana
    - [ ] Configuration de Grafana
    - [ ] Configuration du TLS sur grafana.ng-hl.com
    - [ ] Ouverture du flux sur pfSense vers grafana-core
    - [ ] Int√©grer le renouvellement automatique du certificat via acme-core
    - [ ] Int√©gration de dashboards avec les templates
    - [ ] R√©diger une ficher d'exploitation
- [ ] Netbox
    - [ ] Mise en place du serveur prometheus-core
    - [ ] Int√©gration au niveau de la sauvegarde Proxmox VE
    - [ ] Configuration de l'OS avec Ansible
    - [ ] Installation de la stack Netbox
        - [ ] PostgreSQL
            - [ ] Installation de PostgreSQL
            - [ ] Cr√©ation de la DB
            - [ ] Cr√©ation de l'utilisation de la DB
        - [ ] Installation de Redis
        - [ ] Netbox
            - [ ] Installation
            - [ ] Cr√©ation de l'utilisateur syst√®me pour netbox
            - [ ] Modification de la configuration
        - [ ] Gunicorn
            - [ ] Installation
            - [ ] Configuration
        - [ ] uWSGI
            - [ ] Installation
            - [ ] Configuration
        - [ ] nginx
            - [ ] Installation
            - [ ] Configuration
            - [ ] Mise en place du TLS
    - [ ] R√©diger une fiche d'exploitation
    - [ ] Int√©grer l'existant
        - [ ] IPAM
        - [ ] Virtualisation
    - [ ] R√©diger une fiche d'exploitation
- [ ] Gitlab CI/CD "vm-factory"
    - [ ] Lien avec Prometheus
    - [ ] Lien avec Grafana
    - [ ] Lien avec NetBox
    - [ ] Lien avec Homepage
    - [ ] R√©diger une ficher d'exploitation
- [ ] Homepage
    - [ ] Mise en place du serveur homepage-core
    - [ ] Int√©gration au niveau de la sauvegarde Proxmox VE
    - [ ] Configuration de l'OS avec Ansible
    - [ ] Cr√©ation du volume Docker
    - [ ] D√©ploiement via docker-compose
    - [ ] Mise en place du TLS
    - [ ] Exposition via homepage.ng-hl.com
    - [ ] Evolution dynamique avec la CI/CD "vm-factory"
- [ ] ELK
    - [ ] Mise en place du serveur elk-core
    - [ ] Int√©gration au niveau de la sauvegarde Proxmox VE
    - [ ] Configuration de l'OS avec Ansible
    - [ ] Installation de ELK
        - [ ] Elastic Search
            - [ ] Installation
            - [ ] Configuration
            - [ ] Mise en place du TLS : elastic.ng-hl.com
            - [ ] Ficher d'exploitation
        - [ ] Kibana
            - [ ] Installation
            - [ ] Configuration
            - [ ] Mise en place du TLS kibana.ng-hl.com
            - [ ] Fiche d'exploitation
        - [ ] Logstash
            - [ ] Installation
            - [ ] Configuration
            - [ ] Installation de Filebeat
            - [ ] Configuration de Filebeat
            - [ ] Mise en place du TLS kibana.ng-hl.com
            - [ ] Fiche d'exploitation
    - [ ] Consul
    - [ ] Wazuh
    - [ ] Infrastructure secondaire sous K8s

---

## 6.4. Projets annexes

- [ ] Projet - Agents IA
    - [ ] √âquipe de d√©veloppement d'agents IA
        - [ ] Serveur crewai-vms
            - [ ] Cr√©ation du serveur
            - [ ] Configuration via Ansible
            - [ ] Installation de crewai via python uv
            - [ ] Configuration de crewai
        - [ ] Cr√©ation du d√©p√¥t dev-ia sur Gitlab
        - [ ] Provisionnement sur ChatGPT
        - [ ] Configuration des prompts (1 chef d'√©quipe, 1 d√©veloppeur, 1 testeur, 1 r√©dacteur de documentation)

---

# 7. Inventaire

| Hostname    | IP      | OS        | Hostname expos√©
| :-:       | :-:       | :-:       | :-:       |
| pfsense-core.homelab    | 192.168.100.254    | Debian 12.10 |   
| dns-core.homelab    | 192.168.100.253    | Debian 12.10 |    
| admin-core.homelab    | 192.168.100.252    | Debian 12.10 |    
| pki-core.homelab | 192.168.100.251 | Debian 12.10 |
| ansible-core.homelab | 192.168.100.250 | Debian 12.10 |
| acme-core.homelab | 192.168.100.248 | Debian 12.10 |
| vaultwarden-core.homelab   | 192.168.100.249 | Debian 12.10 | vaultwarden-core.ng-hl.com vaultwarden.ng-hl.com (CNAME) |
| gitlab-core.homelab | 192.168.100.247 | Debian 12.10 | gitlab-core.ng-hl.com gitlab.ng-hl.com (CNAME)
| opentofu-core.homelab | 192.168.100.246 | Debian 12.10 |
| prometheus-core.homelab | 192.168.100.245 | Debian 12.10 | prometheus-core.ng-hl.com prometheus.ng-hl.com (CNAME)
| ansibledev-core.homelab | 192.168.100.11 | Debian 12.10 |
| debian12-template-core.homelab | 192.168.100.10 |¬†Debian 12.10 |
